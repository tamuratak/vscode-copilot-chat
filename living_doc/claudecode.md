**概要**
- `ClaudeAgentManager` は `@anthropic-ai/claude-agent-sdk`/`@anthropic-ai/sdk` を取り込んだ `ClaudeCodeSession` を `LanguageModelServer` から取得したポートと nonce を渡しながら再利用し、リクエストごとにセッションを追跡・再開できるようにしている（セッション開始／プロンプト展開部）。[src/extension/agents/claude/node/claudeCodeAgent.ts#L6-L125]
- `LanguageModelServer` は `AnthropicAdapterFactory` によって `/v1/messages` を `AnthropicAdapter` にマッピングし、`IEndpointProvider` から取得した複数モデルの中から要求されたモデルを選んで SSE ストリームをクライアントに渡す（nonce 検証、リクエストルーティング、トークン追加など）。[src/extension/agents/node/langModelServer.ts#L20-L340]、[src/extension/agents/node/adapters/anthropicAdapter.ts#L21-L305]

**詳細**
- `ClaudeCodeSession` はキュー＋待機ループでリクエストを直列化し、`Options` にローカルサーバの `ANTHROPIC_BASE_URL`/`ANTHROPIC_API_KEY`、`CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC` などの環境変数を渡してクライアント側の `claude-agent-sdk` を起動。`PreToolUse`/`PostToolUse` フックで編集対象 URI を `ExternalEditTracker` に渡して変更前後を追跡する。ストリームメッセージはアシスタント・ユーザー・結果ごとに処理し、ツール使いの記録や完了通知を整理している。[src/extension/agents/claude/node/claudeCodeAgent.ts#L183-L401]、[src/extension/agents/claude/node/claudeCodeAgent.ts#L235-L345]、[src/extension/agents/claude/node/claudeCodeAgent.ts#L298-L401]
- `claudeEditTools` で指定された編集系ツール（Edit/Write/MultiEdit/NotebookEdit）から対象 URI を抽出し、`toolInvocationFormatter` で読みやすいメッセージやリンク付きテキストに変換してチャット履歴やツールパーツとして表示する。その他のツール（Bash/Glob/Grep/LS/Task/ExitPlanMode 等）も専用フォーマットを持ち、TodoWrite は意図的に抑制される。[src/extension/agents/claude/common/claudeTools.ts#L9-L92]、[src/extension/agents/claude/common/toolInvocationFormatter.ts#L15-L102]
- ツール許可は `CoreConfirmationTool` を経由し、Bash では入力コマンドを端末表示、ExitPlanMode では計画表示といった UI を提示。自動承認が可能なファイルは `isFileOkForTool` 経由で判定し、否認された場合は `ClaudeCodeSession.DenyToolMessage` を返す。TodoWrite の結果は `CoreManageTodoList` に変換してコアの Todo リストを更新するなど、Claude の指示を VS Code 内のツールチェーンに橋渡ししている。[src/extension/agents/claude/node/claudeCodeAgent.ts#L444-L578]
- `ClaudeCodeSdkService` は動的に `@anthropic-ai/claude-agent-sdk` を読み込んで `query` を呼び出すことで、テストや DI で差し替えやすくしており、`LanguageModelServer` → `AnthropicAdapter` との組み合わせで Anthropic イベントを Raw メッセージに変換、ツール呼び出しを OpenAI 準拠の `function` ツールにマッピングし、テキスト/ツールイベントを SSE で返す。トークン使用量は Claude が 200k トークンある前提になるよう補正し、初期・最終イベントを整形した上で `x-api-key` による nonce 検証を行っている。[src/extension/agents/claude/node/claudeCodeSdkService.ts#L6-L37]、[src/extension/agents/node/langModelServer.ts#L33-L340]、[src/extension/agents/node/adapters/anthropicAdapter.ts#L21-L305]

必要であれば、ウォッチタスクを動かして実際に Claude セッションを起動したときの `LanguageModelServer` のログと SSE 出力を確認し、`toolsService` に渡すツール出力の内容をデバッグするとより把握しやすくなります。