- **実装**: LanguageModelServer は [src/extension/agents/node/langModelServer.ts#L17-L343] にまとめられており、Anthropic の `/v1/messages` を模倣するアダプターを登録して HTTP サーバを立ち上げます。サーバはランダムなポートと `nonce` で構成され、アダプター経由でリクエスト本文を読み込み `adapter.extractAuthKey` で認証してから [src/extension/agents/node/langModelServer.ts#L54-L115] の `handleChatRequest` に渡します。`handleChatRequest` では `IEndpointProvider` からモデルを取得し、`selectEndpoint` で Claude→gpt-4o-mini などのコピーや部分一致を吸収して [src/extension/agents/node/langModelServer.ts#L147-L315] で実際の `makeChatRequest2` を呼び出します。オリジナルの SSE ストリームイベントは `finishedCb` 経由でテキストとツール呼び出しを `adapter.formatStreamResponse` に変換して `res.write` し、`generateInitialEvents`/`generateFinalEvents` で Header/usage を補足します。`res.on('close')` でキャンセルを伝播し、`CancellationTokenSource` を経由してリクエストを中断しつつ [src/extension/agents/node/langModelServer.ts#L166-L235] でログを残します。`start` は `127.0.0.1` の空きポートで listen し、`stop` と `getConfig` で状態を扱う [src/extension/agents/node/langModelServer.ts#L318-L343] ため、他コンポーネントは簡単に `port`/`nonce` を取得できます。

- **利用箇所**: `ChatSessionsContrib` の Claude と Copilot CLI 用の ServiceCollection でそれぞれ `[ILanguageModelServer, new SyncDescriptor(LanguageModelServer)]` を登録しており、各エージェント階層で単一インスタンスとして共有されます [src/extension/chatSessions/vscode-node/chatSessions.ts#L68-L134]。そのうえで `ClaudeAgentManager` は `getLangModelServer` でインスタンスをキャッシュし、`handleRequest` から `LanguageModelServer.getConfig()` を取り出して Claude Code SDK に渡します [src/extension/agents/claude/node/claudeCodeAgent.ts#L35-L118]。Claude Session は `options.env` に `ANTHROPIC_BASE_URL=http://localhost:${port}` と `ANTHROPIC_API_KEY=nonce` をセットして CLI を起動し、Local LM サーバが実際の `IChatEndpoint` にリクエストを渡せるようにしています [src/extension/agents/claude/node/claudeCodeAgent.ts#L232-L320]。同様に Copilot CLI 系のセッションも同じサービスで動作し、CLI からは通常の Anthropic / OpenAI エンドポイントに見えるように振る舞います。

- **テスト/モック**: ユニットテストではソケットを開かない `MockLanguageModelServer` を用意し、`start` を no-op にして `port`/`nonce` は固定値にできます [src/extension/agents/node/test/mockLanguageModelServer.ts#L12-L20]。テスト用サービス収集 (`createExtensionUnitTestingServices`) では `ILanguageModelServer` にこのモックをバインドし、実際のネットワーク起動を避けたまま Claude や他のサービスを起動できます [src/extension/test/node/services.ts#L30-L126]。

- **設計上の利点**: HTTP サーバ＋アダプターで `IChatEndpoint` を叩く形にすることで、CLI 側は既存の Claude/API パスで通信しつつエンドポイントは既存の `endpointProvider` から動的に取得するため、モデルの追加や認証周りの変更を再利用できます。また、`requestOptions.telemetryProperties` を差し込むことで内部トラッキングや `APIUsage` を最終イベントに含めてクライアントに渡せるし、stream フィードバックを SSE で流す仕組みによりツールコールや差分テキストをそのまま表示できます。`nonce` による簡易認証、`CancellationTokenSource` 連動の切断検出、`selectEndpoint` によるモデル名マッピングなども、外部 CLI という異質な入力源を安全かつ柔軟に受け止めるうえで有効です。

必要であれば Claude/API のフローを追う `test/e2e/cli.stest.ts` や関連テストを動かして、この LM サーバが想定どおり稼働しているかを確認するのが次の自然なステップです。