**Claude Code 連携**
- `ChatSessionsContrib` 側で `claude-code` セッションを `vscode.chat` に登録し、`package.json` 上の `chatSessions` 定義で「ホーム画面アイコン」「`canDelegate`」「ファイル添付対応」などの振る舞いを解説しているため、UI から直接 Claude Code CLI を起動できる仕組みになっています（[src/extension/chatSessions/vscode-node/chatSessions.ts](src/extension/chatSessions/vscode-node/chatSessions.ts#L20-L172)、[package.json](package.json#L4874-L4955)）。
- `ClaudeAgentManager` がローカルの `LanguageModelServer` を立ち上げて `ClaudeCodeSession` を `claude-agent-sdk` の Query に対応する一連のチャットリクエストのキューとして扱い、プロンプト生成・参照の埋め込み・ツール許可（`CoreConfirmationTool`）・`PreToolUse`/`PostToolUse` フック（`claudeEditTools`）・CSV 形式のツール結果変換・ExternalEditTracker 連携を行っているので、VS Code のチャット UI から完全な会話フローを回せます（[src/extension/agents/claude/node/claudeCodeAgent.ts](src/extension/agents/claude/node/claudeCodeAgent.ts#L31-L367)）。
- 会話履歴は `~/.claude/projects/<workspace-slug>/*.jsonl` を `ClaudeCodeSessionService` が `ResourceMap`/キャッシュで読み、添付ファイルや `<system-reminder>` を除去してラベル付けし、`ClaudeChatSessionItemProvider`/`ClaudeChatSessionParticipant` に渡して既存セッションの一覧表示と再開ができるようにしています（[src/extension/agents/claude/node/claudeCodeSessionService.ts](src/extension/agents/claude/node/claudeCodeSessionService.ts#L77-L506)、[src/extension/chatSessions/vscode-node/claudeChatSessionItemProvider.ts](src/extension/chatSessions/vscode-node/claudeChatSessionItemProvider.ts#L15-L66)、[src/extension/chatSessions/vscode-node/claudeChatSessionParticipant.ts](src/extension/chatSessions/vscode-node/claudeChatSessionParticipant.ts#L11-L53)）。

**Copilot CLI 連携**
- `ChatSessionsContrib` で `copilotcli` タイプのセッションが登録され、`CopilotCLIChatSessionItemProvider`/`CopilotCLIChatSessionContentProvider`/`CopilotCLIChatSessionParticipant` を通じてモデル・エージェント・隔離（worktree）オプションが `requestHandler` を介して公開され、専用コマンド群も登録されることで「背景エージェント」としての操作が完結します（[src/extension/chatSessions/vscode-node/chatSessions.ts](src/extension/chatSessions/vscode-node/chatSessions.ts#L20-L172)、[src/extension/chatSessions/vscode-node/copilotCLIChatSessionsContribution.ts](src/extension/chatSessions/vscode-node/copilotCLIChatSessionsContribution.ts#L130-L330)、[src/extension/chatSessions/vscode-node/copilotCLIChatSessionsContribution.ts#L998-L1110)、[package.json](package.json#L4918-L4955)）。
- `CopilotCLISessionService` が `@github/copilot/sdk` の内部 `LocalSessionManager` を通じて `~/.copilot/session-state/*.jsonl` を監視しつつセッションを保持し、`CopilotCLISession` が SDK イベント（ストリーミング応答、ツール開始/完了、パーミッション）を `ExternalEditTracker` や `ToolsService` を使ってチャット UI に流し込み、`requestPermission` → `permissionHelpers` で CLI の read/write/shell コマンドについて確認を取ります。セッション設定は `CopilotCLISessionOptions` でモデル・作業ディレクトリ・エージェント・MCP サーバーをラップし、`CopilotCLIModels`/`CopilotCLIAgents`・`CopilotCLISDK` がモデルや SDK のロード、`node-pty`/ripgrep シムの準備、認証情報の取得、最後のリクエスト ID マッピングを担います（[src/extension/agents/copilotcli/node/copilotcliSessionService.ts](src/extension/agents/copilotcli/node/copilotcliSessionService.ts#L86-L324)、[src/extension/agents/copilotcli/node/copilotcliSession.ts](src/extension/agents/copilotcli/node/copilotcliSession.ts#L43-L318)、[src/extension/agents/copilotcli/node/copilotCli.ts](src/extension/agents/copilotcli/node/copilotCli.ts#L31-L349)、[src/extension/agents/copilotcli/node/permissionHelpers.ts](src/extension/agents/copilotcli/node/permissionHelpers.ts#L1-L134)）。
- CLI のプロンプトは `CopilotCLIPromptResolver` が `ChatVariablesCollection` に基づいて参照＝変数化し、ファイル/フォルダー/画像を `copilot-cli-images` ディレクトリに保存する `CopilotCLIImageSupport` 経由で添付しつつ `isolation` に応じて作業ディレクトリへの URI 変換や参照除外を行い、`CopilotCLISession` に渡しています（[src/extension/agents/copilotcli/node/copilotcliPromptResolver.ts](src/extension/agents/copilotcli/node/copilotcliPromptResolver.ts#L38-L191)、[src/extension/agents/copilotcli/node/copilotCLIImageSupport.ts](src/extension/agents/copilotcli/node/copilotCLIImageSupport.ts#L17-L63)）。
- `.copilot` CLI を直接起動するには `CopilotCLITerminalIntegration` が `globalStorage/copilotCli` 配下に `copilot` 用シェル/バッチ/PowerShell スクリプトを書き出し、Python 統合のターミナル経由で `--clear` 付きコマンドを送るためのヘルパーを提供し、起動時には `copilotCLIShim`（npm 版 Copilot CLI の存在チェック・最低バージョン要求・インストール支援）を呼び出す仕組みです（[src/extension/chatSessions/vscode-node/copilotCLITerminalIntegration.ts](src/extension/chatSessions/vscode-node/copilotCLITerminalIntegration.ts#L25-L210)、[src/extension/chatSessions/vscode-node/copilotCLIShim.ts](src/extension/chatSessions/vscode-node/copilotCLIShim.ts#L24-L132)）。
- `CopilotCLIChatSessionParticipant` はリクエストのたびに `model/agent` の決定・worktree 隔離設定・`contextForRequest` による添付再利用・チャット履歴要約・`createCLISessionAndSubmitRequest`（未コミット変更の移動/コピー/スキップ含む）・クラウド委譲 (`/delegate`) などを統括し、`registerCLIChatCommands` でセッション削除/ターミナル再開/ワークツリー差分/apply 操作を公開しますので、UI とバックエンドが一体化した背景エージェント体験になっています（[src/extension/chatSessions/vscode-node/copilotCLIChatSessionsContribution.ts](src/extension/chatSessions/vscode-node/copilotCLIChatSessionsContribution.ts#L360-L1110)、特に `contextForRequest`, `getOrCreateSession`, worktree 関連 `moveOrCopyChangesToWorkTree`, `createCLISessionAndSubmitRequest`, `registerCLIChatCommands` などのセクション）。
- 追加で `Copilot CLI` セッションは `CopilotCLISessionIsolationManager`/`IChatSessionWorktreeService` を使って isolation 設定や git worktree の作成・マイグレーション・適用を敷衍し、`CopilotCLIWorktreeManagerService` 経由で完了時に変更内容をコミットするパイプラインも持っています（[src/extension/chatSessions/vscode-node/copilotCLIChatSessionsContribution.ts](src/extension/chatSessions/vscode-node/copilotCLIChatSessionsContribution.ts#L232-L940)）。

ご質問があれば、さらなるコード箇所の精査や動作確認のために `npm run watch:*` の出力を読むなど対応できますので、お気軽にお知らせください。